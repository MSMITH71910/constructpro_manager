<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConstructPro Manager - Integration Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .test-container {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-result {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-radius: 5px;
        }
        
        .test-pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .test-fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .test-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .test-section {
            margin: 2rem 0;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .demo-controls {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="text-center mb-4">
            <h1><i class="bi bi-shield-check text-success"></i> ConstructPro Authentication System</h1>
            <h2>Integration Test Suite</h2>
            <p class="lead">Testing complete authentication flow integration with the main application</p>
        </div>

        <div class="demo-controls">
            <h4><i class="bi bi-play-circle"></i> Interactive Demo</h4>
            <p>Use these controls to test the authentication system manually:</p>
            <div class="row">
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" onclick="showLogin()">
                        <i class="bi bi-box-arrow-in-right"></i> Show Login Screen
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-success w-100" onclick="loginDemo()">
                        <i class="bi bi-person-check"></i> Login as Demo User
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-warning w-100" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3><i class="bi bi-list-check"></i> Automated Tests</h3>
            <button class="btn btn-info" onclick="runTests()">Run All Tests</button>
            <div id="testResults" class="mt-3">
                <div class="test-info">Click "Run All Tests" to start the test suite</div>
            </div>
        </div>

        <div class="test-section">
            <h3><i class="bi bi-gear"></i> System Status</h3>
            <div id="systemStatus">
                <div class="test-info">System status will be shown here</div>
            </div>
        </div>

        <div class="test-section">
            <h3><i class="bi bi-person-circle"></i> Current User</h3>
            <div id="userStatus">
                <div class="test-info">User status will be shown here</div>
            </div>
        </div>

        <div id="authContainer" class="test-section" style="display: none;">
            <!-- Authentication forms will be inserted here -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../src/renderer/modules/AuthManager.js"></script>
    
    <script>
        class IntegrationTest {
            constructor() {
                this.tests = [];
                this.passed = 0;
                this.failed = 0;
                this.authManager = null;
                this.init();
            }

            init() {
                this.authManager = new AuthManager();
                this.updateSystemStatus();
                this.updateUserStatus();
                
                // Listen for auth events
                window.addEventListener('authStateChanged', (event) => {
                    this.updateUserStatus();
                });
            }

            updateSystemStatus() {
                const status = document.getElementById('systemStatus');
                const authManagerLoaded = !!this.authManager;
                const localStorageAvailable = typeof(Storage) !== "undefined";
                const bootstrapLoaded = typeof bootstrap !== 'undefined';
                
                status.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="${authManagerLoaded ? 'test-pass' : 'test-fail'} test-result">
                                <strong>AuthManager:</strong> ${authManagerLoaded ? '✅ Loaded' : '❌ Not Loaded'}
                            </div>
                            <div class="${localStorageAvailable ? 'test-pass' : 'test-fail'} test-result">
                                <strong>localStorage:</strong> ${localStorageAvailable ? '✅ Available' : '❌ Not Available'}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="${bootstrapLoaded ? 'test-pass' : 'test-fail'} test-result">
                                <strong>Bootstrap:</strong> ${bootstrapLoaded ? '✅ Loaded' : '❌ Not Loaded'}
                            </div>
                            <div class="test-info test-result">
                                <strong>Demo Users:</strong> ${this.authManager ? this.authManager.users.length : 0} registered
                            </div>
                        </div>
                    </div>
                `;
            }

            updateUserStatus() {
                const status = document.getElementById('userStatus');
                const user = this.authManager ? this.authManager.getCurrentUser() : null;
                const isAuthenticated = this.authManager ? this.authManager.isUserAuthenticated() : false;
                
                if (isAuthenticated && user) {
                    status.innerHTML = `
                        <div class="test-pass test-result">
                            <strong>Authentication Status:</strong> ✅ Logged In<br>
                            <strong>User:</strong> ${user.firstName} ${user.lastName} (${user.username})<br>
                            <strong>Company:</strong> ${user.company}<br>
                            <strong>Role:</strong> ${user.role}<br>
                            <strong>Session:</strong> Active
                        </div>
                    `;
                } else {
                    status.innerHTML = `
                        <div class="test-fail test-result">
                            <strong>Authentication Status:</strong> ❌ Not Logged In<br>
                            <strong>User:</strong> None<br>
                            <strong>Session:</strong> Inactive
                        </div>
                    `;
                }
            }

            logTest(message, passed) {
                const result = document.createElement('div');
                result.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
                result.innerHTML = `${passed ? '✅' : '❌'} ${message}`;
                document.getElementById('testResults').appendChild(result);
                
                if (passed) this.passed++;
                else this.failed++;
            }

            async runTests() {
                document.getElementById('testResults').innerHTML = '<div class="test-info">Running tests...</div>';
                this.passed = 0;
                this.failed = 0;

                // Test 1: AuthManager initialization
                this.logTest('AuthManager should be initialized', !!this.authManager);

                // Test 2: Demo user creation
                const demoUser = this.authManager.users.find(u => u.username === 'demo');
                this.logTest('Demo user should be created automatically', !!demoUser);

                // Test 3: User registration
                const registrationResult = this.authManager.handleRegistration({
                    firstName: 'Test',
                    lastName: 'User',
                    username: 'testuser123',
                    email: 'test@example.com',
                    company: 'Test Company',
                    role: 'contractor',
                    password: 'testpass123',
                    confirmPassword: 'testpass123',
                    agreeTerms: true
                });
                this.logTest('User registration should work', registrationResult.success);

                // Test 4: User login with valid credentials
                const loginResult = this.authManager.attemptLogin('demo', 'demo123', false);
                this.logTest('Login with valid credentials should work', loginResult.success);

                // Test 5: Session validation
                const isAuthenticated = this.authManager.isUserAuthenticated();
                this.logTest('User should be authenticated after login', isAuthenticated);

                // Test 6: User data retrieval
                const currentUser = this.authManager.getCurrentUser();
                this.logTest('Current user data should be available', !!currentUser);

                // Test 7: Username validation
                const validUsername = this.authManager.validateUsername('validuser123');
                const invalidUsername = this.authManager.validateUsername('ab');
                this.logTest('Username validation should work correctly', validUsername && !invalidUsername);

                // Test 8: Email validation
                const validEmail = this.authManager.validateEmail('test@example.com');
                const invalidEmail = this.authManager.validateEmail('invalid-email');
                this.logTest('Email validation should work correctly', validEmail && !invalidEmail);

                // Test 9: Password validation
                const validPassword = this.authManager.validatePassword('password123');
                const invalidPassword = this.authManager.validatePassword('123');
                this.logTest('Password validation should work correctly', validPassword && !invalidPassword);

                // Test 10: Logout functionality
                this.authManager.logout();
                const loggedOut = !this.authManager.isUserAuthenticated();
                this.logTest('Logout should clear authentication', loggedOut);

                // Show results summary
                const summary = document.createElement('div');
                summary.className = 'test-info test-result mt-3';
                summary.innerHTML = `
                    <strong>Test Summary:</strong><br>
                    ✅ Passed: ${this.passed}<br>
                    ❌ Failed: ${this.failed}<br>
                    📈 Success Rate: ${((this.passed / (this.passed + this.failed)) * 100).toFixed(1)}%
                `;
                document.getElementById('testResults').appendChild(summary);
            }
        }

        // Global functions for demo controls
        function showLogin() {
            if (window.testRunner.authManager) {
                window.testRunner.authManager.showAuthScreen();
            }
        }

        function loginDemo() {
            if (window.testRunner.authManager) {
                const result = window.testRunner.authManager.attemptLogin('demo', 'demo123', false);
                if (result.success) {
                    alert('✅ Successfully logged in as demo user!');
                } else {
                    alert('❌ Failed to login: ' + result.message);
                }
            }
        }

        function logout() {
            if (window.testRunner.authManager) {
                window.testRunner.authManager.logout();
                alert('✅ Successfully logged out!');
            }
        }

        function runTests() {
            window.testRunner.runTests();
        }

        // Initialize test runner
        window.addEventListener('load', () => {
            window.testRunner = new IntegrationTest();
            console.log('Integration test environment ready');
        });
    </script>
</body>
</html>